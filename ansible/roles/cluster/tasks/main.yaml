---
# Tasks for cluster role
- name: 'Generate hardware.csv'
  ansible.builtin.template:
    src: ../../templates/hardware.csv.j2
    dest: '{{ work_dir }}/hardware.csv'
    mode: '0644'

- name: 'Generate cluster.yaml'
  ansible.builtin.template:
    src: ../../templates/cluster.yaml.j2
    dest: '{{ work_dir }}/{{ cluster_name }}.yaml'
    mode: '0644'

- name: Find bundle-release.yaml
  ansible.builtin.find:
    paths: "{{ work_dir }}"
    patterns: "bundle-release.yaml"
    recurse: yes
  register: found_bundle_file
  become: true
  when: airgapped_environment

- name: 'Create EKS-A cluster'
  become: true
  ansible.builtin.command:
    cmd: >-
      eksctl anywhere create cluster
      -f {{ cluster_name }}.yaml
      --hardware-csv hardware.csv
      --bundles-override {{ found_bundle_file.files[0].path }}
    chdir: "{{ work_dir }}"
  environment:
    REGISTRY_USERNAME: "{{ registry_username }}"
    REGISTRY_PASSWORD: "{{ registry_password }}"
  run_once: true
  when: airgapped_environment

- name: 'Create EKS-A cluster (non-airgapped)'
  become: true
  ansible.builtin.command:
    cmd: 'eksctl anywhere create cluster -f {{ cluster_name }}.yaml --hardware-csv hardware.csv'
    chdir: '{{ work_dir }}'
  run_once: true
  when: not airgapped_environment
